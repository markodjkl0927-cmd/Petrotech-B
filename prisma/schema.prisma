generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  password       String
  firstName      String
  lastName       String
  phone          String?
  role           UserRole       @default(CUSTOMER)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  addresses      Address[]
  orders         Order[]
  chargingOrders ChargingOrder[]
  cars           Car[]
  pushTokens     PushToken[]

  @@map("users")
}

model Address {
  id             String         @id @default(uuid())
  userId         String
  label          String
  street         String
  city           String
  state          String?
  zipCode        String
  country        String         @default("US")
  latitude       Float?
  longitude      Float?
  isDefault      Boolean        @default(false)
  instructions   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders         Order[]
  chargingOrders ChargingOrder[]

  @@map("addresses")
}

model Product {
  id            String      @id @default(uuid())
  name          String
  description   String?
  pricePerLiter Float
  unit          String      @default("liter")
  isAvailable   Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  orderItems    OrderItem[]

  @@map("products")
}

model Driver {
  id                     String         @id @default(uuid())
  firstName              String
  lastName               String
  email                  String         @unique
  password               String?
  phone                  String
  photoUrl               String?
  licenseNumber          String
  vehicleType            String
  vehicleNumber          String
  isAvailable            Boolean         @default(true)
  isActive               Boolean         @default(true)
  stripeConnectAccountId String?         @unique // Stripe Connect Express account for payouts
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  orders                 Order[]
  chargingOrders         ChargingOrder[]
  location               DriverLocation?
  payouts                DriverPayout[]
  pushTokens             PushToken[]
  notifications          DriverNotification[]

  @@map("drivers")
}

model DriverNotification {
  id        String    @id @default(uuid())
  driverId  String
  type      String    // order_assigned, order_status, charging_assigned, charging_status, payout_succeeded, payout_failed
  title     String
  body      String
  data      String?   // JSON: orderId, etc.
  readAt    DateTime?
  createdAt DateTime  @default(now())

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_notifications")
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String?
  driverId  String?
  token     String   // Expo push token (ExponentPushToken[...])
  platform  String   // ios | android | web
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  driver Driver? @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("push_tokens")
}

model DriverPayout {
  id                String       @id @default(uuid())
  driverId          String
  amount            Float        // Amount in dollars
  status            PayoutStatus @default(PENDING)
  stripeTransferId  String?
  failureReason     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  driver            Driver       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_payouts")
}

enum PayoutStatus {
  PENDING
  SUCCEEDED
  FAILED
}

model DriverLocation {
  id        String   @id @default(uuid())
  driverId  String   @unique
  latitude  Float
  longitude Float
  accuracy  Float?
  heading   Float?
  speed     Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_locations")
}

model Order {
  id                 String        @id @default(uuid())
  userId             String
  addressId          String
  driverId           String?
  orderNumber        String        @unique
  deliveryType       DeliveryType
  status             OrderStatus   @default(PENDING)
  paymentMethod      PaymentMethod
  paymentStatus      PaymentStatus @default(PENDING)
  totalAmount        Float
  fuelCost           Float         @default(0) // Total fuel cost (goes to gas company)
  companyMarkup      Float          @default(0) // 0.095% markup on fuel (goes to company)
  distance           Float?         // Distance in miles
  deliveryFee        Float          @default(0) // Delivery fee based on distance (goes to company)
  tax                Float          @default(0) // Tax amount (goes to customer/government)
  tip                Float          @default(0) // Optional tip for driver
  deliveryDate       DateTime?
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  notes              String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  orderItems         OrderItem[]
  address            Address       @relation(fields: [addressId], references: [id])
  driver             Driver?       @relation(fields: [driverId], references: [id])
  user               User          @relation(fields: [userId], references: [id])

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Float
  price     Float
  subtotal  Float
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

enum UserRole {
  CUSTOMER
  ADMIN
  DRIVER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  DISPATCHED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  ONLINE
  CASH_ON_DELIVERY
  CARD_ON_DELIVERY
}

enum DeliveryType {
  PRIVATE
  COMMERCIAL
}

model Car {
  id            String         @id @default(uuid())
  userId        String
  make          String         // e.g., "Tesla", "Ford"
  model         String         // e.g., "Model 3", "Mustang Mach-E"
  year          Int?
  connectorType String         // "CCS", "CHAdeMO", "Tesla", "Type 2"
  batteryCapacity Float?       // kWh
  licensePlate  String?
  color         String?
  nickname      String?        // User-friendly name
  isDefault     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chargingOrderCars ChargingOrderCar[]

  @@map("cars")
}

model ChargingUnit {
  id            String         @id @default(uuid())
  name          String         // e.g., "Mobile Charger #1"
  type          String         // "Level 2" or "DC Fast"
  connectorType String         // "CCS", "CHAdeMO", "Tesla", "Universal"
  maxPower      Float          // kW rating
  isAvailable   Boolean        @default(true)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  chargingOrders ChargingOrder[]

  @@map("charging_units")
}

model ChargingOrder {
  id              String            @id @default(uuid())
  userId          String
  addressId       String
  driverId        String?
  chargingUnitId  String?
  orderNumber     String            @unique
  chargingDuration ChargingDuration // 1 hour, 2 hours, 5 hours, 24 hours
  numberOfCars    Int               @default(1) // Number of cars to charge
  baseFee         Float             @default(0) // Base fee for selected duration
  deliveryFee     Float             @default(0) // Distance-based delivery fee
  distance        Float             @default(0) // Distance in miles
  tax              Float            @default(0)
  tip              Float            @default(0)
  totalAmount      Float
  status           ChargingOrderStatus @default(PENDING)
  paymentMethod    PaymentMethod
  paymentStatus    PaymentStatus   @default(PENDING)
  scheduledAt      DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  cancelledAt      DateTime?
  cancellationReason String?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id])
  address          Address         @relation(fields: [addressId], references: [id])
  driver           Driver?         @relation(fields: [driverId], references: [id])
  chargingUnit     ChargingUnit?   @relation(fields: [chargingUnitId], references: [id])
  cars             ChargingOrderCar[]

  @@map("charging_orders")
}

model ChargingOrderCar {
  id              String         @id @default(uuid())
  chargingOrderId String
  carId           String
  createdAt       DateTime       @default(now())
  chargingOrder   ChargingOrder  @relation(fields: [chargingOrderId], references: [id], onDelete: Cascade)
  car             Car            @relation(fields: [carId], references: [id])

  @@unique([chargingOrderId, carId])
  @@map("charging_order_cars")
}

enum ChargingOrderStatus {
  PENDING
  CONFIRMED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ChargingDuration {
  ONE_HOUR
  TWO_HOURS
  FIVE_HOURS
  TWENTY_FOUR_HOURS
}
